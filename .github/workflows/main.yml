# .github/workflows/cloud-run.yml

name: Cloud Run Deployment

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE: Poseidon-Backend
  REGION: europe-central2
  DOCKER_IMAGE: poseidon_backend

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
  
      # - name: 'Set up Cloud SDK'
      #   uses: 'google-github-actions/setup-gcloud@v2'
  
      # - name: 'Use gcloud CLI'
      #   run: 'gcloud info'

      # Configure Docker
      # - name: Configure docker for GCP
      #   run: gcloud auth configure-docker  
        
      - name: Build and push Docker image to google cloud container registry
        uses: RafikFarhad/push-to-gcr-github-action@v5-rc1
        with:
          # gcloud_service_key: ${{ secrets.GCLOUD_SERVICE_KEY }} # can be base64 encoded or plain text || not needed if you use google-github-actions/auth
          registry: gcr.io
          project_id: ${{ env.DOCKER_IMAGE }}
          image_name: ${{ env.DOCKER_IMAGE }}
          image_tag: latest
          dockerfile: ./dockerfile
          context: .
    